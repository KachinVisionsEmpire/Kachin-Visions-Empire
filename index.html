<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kachin Visions Empire</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Kachin Visions Empire">
    <meta name="apple-mobile-web-app-title" content="KachinVisions">
    <meta name="description" content="Kachin Visions Empire - Premium Video Streaming Platform">
    <meta name="keywords" content="Kachin, Videos, Movies, Streaming, Entertainment">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" href="https://res.cloudinary.com/zaumaran/image/upload/v1764932924/Kachin_Vision_Empire_For_Logo_zpkdbg.png" type="image/png">
    <link rel="apple-touch-icon" href="https://res.cloudinary.com/zaumaran/image/upload/v1764932924/Kachin_Vision_Empire_For_Logo_zpkdbg.png">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#ff9900">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body.digital-mode {
            --primary: #ff9900;
            --secondary: #ff5500;
            --accent: #ffcc00;
            --accent-glow: rgba(255, 204, 0, 0.7);
            --dark: #0a0a1a;
            --darker: #050510;
            --light: #f0f8ff;
            --gray: #8a93a7;
            --success: #00ffcc;
            --warning: #ffcc00;
            --danger: #ff3e3e;
            --card-bg: rgba(15, 20, 40, 0.9);
            --card-border: rgba(255, 153, 0, 0.3);
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
            --card-glow: 0 0 15px rgba(255, 153, 0, 0.4);
            --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-slow: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --border-radius: 12px;
            background: linear-gradient(135deg, var(--darker), var(--dark), #1a0f0a);
            color: var(--light);
        }

        body {
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            position: relative;
            font-size: 8px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
            padding-bottom: 60px;
        }

        .screen {
            display: none;
            min-height: 100vh;
            padding: 10px;
            animation: fadeIn 0.5s ease-in-out;
            position: relative;
        }

        .active {
            display: block;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            position: relative;
            z-index: 10;
            gap: 10px;
            flex-wrap: wrap;
        }

        .top-bar-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            max-width: 200px;
        }

        .logo-container {
            position: relative;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 5px;
        }

        .kachin-visions-logo {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            position: relative;
            perspective: 1000px;
            color: #ff9900;
            animation: sunRise 3s ease-in-out infinite alternate;
            text-shadow: 0 0 10px rgba(255, 153, 0, 0.5),
                         0 0 20px rgba(255, 153, 0, 0.3),
                         0 0 30px rgba(255, 153, 0, 0.1);
        }

        .kachin-visions-logo .kachin {
            color: inherit;
            display: inline-block;
            position: relative;
            animation: sunPulse 3s ease-in-out infinite;
        }

        .kachin-visions-logo .visions {
            color: inherit;
            display: inline-block;
            position: relative;
            transform-style: preserve-3d;
            transition: var(--transition-slow);
            animation: lightWave 4s ease-in-out infinite;
        }

        .kachin-visions-logo::before {
            content: 'Kachin Visions Empire';
            position: absolute;
            top: 2px;
            left: 2px;
            color: rgba(255, 85, 0, 0.5);
            z-index: -1;
            filter: blur(2px);
        }

        @keyframes sunRise {
            0% {
                transform: translateY(0) rotateX(0deg);
                text-shadow: 0 0 10px rgba(255, 153, 0, 0.5);
            }
            100% {
                transform: translateY(-5px) rotateX(20deg);
                text-shadow: 0 0 20px rgba(255, 153, 0, 0.8),
                             0 0 40px rgba(255, 153, 0, 0.4);
            }
        }

        @keyframes sunPulse {
            0%, 100% {
                transform: scale(1);
                color: #ff9900;
            }
            50% {
                transform: scale(1.1);
                color: #ffcc00;
            }
        }

        @keyframes lightWave {
            0%, 100% {
                transform: translateX(0) skewY(0deg);
                color: #f0f8ff;
            }
            50% {
                transform: translateX(5px) skewY(-5deg);
                color: #ffffff;
                text-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
            }
        }

        .compact-password-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 8px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            transition: var(--transition);
            width: 100%;
            font-size: 8px;
            overflow: hidden;
            position: relative;
        }

        .compact-password-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .compact-password-section .form-title {
            font-size: 8px;
            margin-bottom: 6px;
            color: var(--light);
            text-align: center;
            font-weight: 600;
            transition: var(--transition);
        }

        .compact-password-section .form-group {
            margin-bottom: 6px;
            transition: var(--transition);
        }

        .compact-password-section .form-input {
            padding: 6px;
            font-size: 8px;
            background: var(--dark);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            color: var(--light);
            width: 100%;
            transition: var(--transition);
            min-height: 28px;
            box-sizing: border-box;
        }

        .compact-password-section .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .compact-password-section .form-input::placeholder {
            color: var(--gray);
            font-size: 8px;
        }

        .compact-password-section .submit-btn {
            padding: 6px;
            font-size: 8px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            width: 100%;
            min-height: 28px;
            box-sizing: border-box;
            overflow: hidden;
            white-space: nowrap;
        }

        .compact-password-section .submit-btn:hover {
            transform: translateY(-2px);
        }

        .compact-password-section .login-status {
            text-align: center;
            margin-top: 6px;
            font-size: 8px;
            transition: var(--transition);
        }

        .story-password-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            max-width: 300px;
            align-items: flex-end;
        }

        @media (min-width: 768px) {
            .story-password-row {
                flex-direction: row;
                align-items: flex-start;
                justify-content: flex-end;
            }
        }

        .story-collection-menu {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            flex: 0 0 auto;
            min-width: 80px;
        }

        .story-menu-toggle {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 6px 8px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
            font-size: 8px;
            color: var(--light);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            min-height: 28px;
            width: 100%;
            justify-content: center;
        }

        .story-menu-toggle:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .story-menu {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 8px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            min-width: 120px;
            z-index: 100;
            display: none;
        }

        .story-menu.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        .story-menu-title {
            text-align: center;
            margin-bottom: 8px;
            font-size: 8px;
            color: var(--light);
            font-weight: 600;
        }

        .story-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .story-item {
            background: rgba(0, 0, 0, 0.1);
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--card-border);
            font-weight: 600;
            font-size: 8px;
            min-height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .story-item:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .story-item.active {
            background: rgba(0, 0, 0, 0.3);
        }

        .story-password-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 8px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            margin-bottom: 0;
            display: none;
            width: 180px;
            flex: 0 0 auto;
            min-width: 150px;
            position: relative;
            overflow: hidden;
        }

        .story-password-section.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .story-password-section .form-title {
            font-size: 8px;
            margin-bottom: 6px;
            color: var(--light);
            text-align: center;
            font-weight: 600;
        }

        .story-password-section .form-group {
            margin-bottom: 6px;
        }

        .story-password-section .form-input {
            padding: 6px;
            font-size: 8px;
            background: var(--dark);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            color: var(--light);
            width: 100%;
            transition: var(--transition);
            min-height: 28px;
        }

        .story-password-section .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .story-password-section .form-input::placeholder {
            color: var(--gray);
            font-size: 8px;
        }

        .story-password-section .submit-btn {
            padding: 6px;
            font-size: 8px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            width: 100%;
            min-height: 28px;
        }

        .story-password-section .submit-btn:hover {
            transform: translateY(-2px);
        }

        .story-password-section .login-status {
            text-align: center;
            margin-top: 6px;
            font-size: 8px;
        }

        .password-timer-display {
            position: fixed;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: var(--light);
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 8px;
            z-index: 1000;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid var(--card-border);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .app-footer {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 8px;
            opacity: 0.4;
            color: var(--light);
            font-family: 'Courier New', monospace;
            z-index: 1000;
        }

        .back-btn-container {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 100;
        }

        .back-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 8px;
            min-height: 28px;
        }

        .back-btn:hover {
            transform: translateY(-2px);
        }

        .video-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .video-section {
                flex-direction: row;
            }
        }

        .main-video-container {
            width: 100%;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            position: relative;
            aspect-ratio: 16/9;
            border: 1px solid var(--card-border);
            transition: var(--transition);
        }

        @media (min-width: 768px) {
            .main-video-container {
                flex: 2;
            }
        }

        .main-video-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .video-player {
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .video-player-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .black-bars {
            position: absolute;
            left: 0;
            right: 0;
            background: #000;
            z-index: 10;
            pointer-events: none;
        }

        .top-bar {
            top: 0;
        }

        .bottom-bar {
            bottom: 0;
        }

        .video-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .video-list-container {
            width: 100%;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 12px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            transition: var(--transition);
            font-size: 8px;
        }

        @media (min-width: 768px) {
            .video-list-container {
                flex: 1;
            }
        }

        .video-list-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .video-list-title {
            text-align: center;
            margin-bottom: 12px;
            font-size: 9px;
            color: var(--light);
            font-weight: 600;
        }

        .video-list {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 5px;
            font-size: 8px;
        }

        .video-list::-webkit-scrollbar {
            width: 4px;
        }

        .video-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .video-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 5px;
        }

        .video-list::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        .video-item {
            background: rgba(0, 0, 0, 0.05);
            margin-bottom: 6px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid transparent;
            position: relative;
            overflow: hidden;
            min-height: 40px;
            font-size: 8px;
        }

        .video-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: var(--transition-slow);
        }

        .video-item:hover::before {
            left: 100%;
        }

        .video-item:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: translateX(4px);
            border-left-color: var(--accent);
        }

        .video-item.locked {
            background: rgba(255, 0, 0, 0.05);
            cursor: not-allowed;
        }

        .video-item.locked:hover {
            background: rgba(255, 0, 0, 0.1);
            transform: none;
            border-left-color: transparent;
        }

        .video-item.free {
            background: rgba(0, 255, 204, 0.03);
            border-left-color: var(--success);
        }

        .video-item.free:hover {
            background: rgba(0, 255, 204, 0.06);
        }

        .free-badge {
            background: var(--secondary);
            color: white;
            padding: 2px 4px;
            border-radius: 10px;
            font-size: 6px;
            margin-left: 6px;
            font-weight: 600;
        }

        .admin-message-container {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            transition: var(--transition);
            font-size: 8px;
        }

        .admin-message-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .admin-message-title {
            text-align: center;
            margin-bottom: 8px;
            font-size: 9px;
            color: var(--light);
            font-weight: 600;
        }

        .admin-message-content {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            min-height: 60px;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            font-size: 8px;
            line-height: 1.6;
        }

        .downloaded-videos-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--card-border);
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        @media (min-width: 768px) {
            .btn-group {
                flex-direction: row;
                justify-content: space-between;
            }
        }

        .nav-btn {
            padding: 8px 12px;
            border-radius: var(--border-radius);
            border: none;
            background: var(--primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: var(--card-shadow);
            font-size: 8px;
            min-height: 32px;
        }

        @media (min-width: 768px) {
            .nav-btn {
                width: auto;
            }
        }

        .nav-btn:hover {
            transform: translateY(-3px);
        }

        .contact-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            min-width: 100px;
            justify-content: center;
            font-size: 8px;
            min-height: 32px;
        }

        .facebook-btn {
            background: #1877F2;
            color: white;
        }

        .telegram-btn {
            background: #0088cc;
            color: white;
        }

        .viber-btn {
            background: #7360F2;
            color: white;
        }

        .contact-btn:hover {
            transform: translateY(-3px);
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 6px 8px;
            border-radius: 15px;
            font-size: 8px;
            z-index: 1000;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }

        .online-status-badge {
            background: var(--success);
        }

        .offline-status-badge {
            background: var(--danger);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 10px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--dark);
            padding: 15px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 300px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            animation: modalSlideIn 0.4s ease-out;
            font-size: 8px;
        }

        .modal-title {
            text-align: center;
            margin-bottom: 12px;
            font-size: 9px;
            color: var(--light);
            font-weight: 600;
        }

        .close-modal {
            float: right;
            font-size: 1rem;
            cursor: pointer;
            color: var(--light);
            transition: var(--transition);
            min-height: 24px;
            min-width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            transform: scale(1.1);
        }

        .form-container {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            transition: var(--transition);
            font-size: 8px;
        }

        .form-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .form-title {
            text-align: center;
            margin-bottom: 12px;
            font-size: 9px;
            color: var(--light);
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: var(--light);
            font-size: 8px;
        }

        .form-input {
            width: 100%;
            padding: 8px;
            border-radius: var(--border-radius);
            border: 1px solid var(--card-border);
            background: var(--dark);
            font-size: 8px;
            color: var(--light);
            transition: var(--transition);
            min-height: 32px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-input::placeholder {
            color: var(--gray);
            font-size: 8px;
        }

        .submit-btn {
            width: 100%;
            padding: 8px;
            border-radius: var(--border-radius);
            border: none;
            background: var(--success);
            color: white;
            font-size: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-height: 32px;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
        }

        .digital-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 153, 0, 0.25) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 204, 0, 0.25) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 85, 0, 0.25) 0%, transparent 50%),
                linear-gradient(45deg, transparent 30%, rgba(255, 153, 0, 0.1) 50%, transparent 70%);
            z-index: -1;
            animation: bgPulse 10s infinite alternate;
        }

        .digital-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 153, 0, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 153, 0, 0.1) 1px, transparent 1px),
                linear-gradient(rgba(255, 204, 0, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 204, 0, 0.05) 1px, transparent 1px);
            background-size: 50px 50px, 50px 50px, 20px 20px, 20px 20px;
            z-index: -1;
            opacity: 0.8;
            animation: gridMove 20s linear infinite;
        }

        .digital-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: radial-gradient(circle, rgba(255, 204, 0, 0.8) 0%, rgba(255, 153, 0, 0.4) 50%, transparent 70%);
            border-radius: 50%;
            animation: float 15s infinite linear;
            filter: blur(1px);
        }

        .particle.sun {
            background: radial-gradient(circle, rgba(255, 255, 255, 0.9) 0%, rgba(255, 204, 0, 0.6) 30%, rgba(255, 153, 0, 0.3) 60%, transparent 80%);
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.5);
        }

        @keyframes bgPulse {
            0% {
                opacity: 0.7;
                transform: scale(1);
            }
            100% {
                opacity: 1;
                transform: scale(1.02);
            }
        }

        @keyframes gridMove {
            0% {
                background-position: 0 0, 0 0, 0 0, 0 0;
            }
            100% {
                background-position: 50px 50px, 50px 50px, 20px 20px, 20px 20px;
            }
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }

        .style-selector {
            position: fixed;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 6px;
            z-index: 1000;
        }

        .style-btn {
            padding: 6px 8px;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-size: 8px;
            min-height: 28px;
        }

        .normal-mode-btn {
            background: #4a6baf;
            color: white;
        }

        .digital-mode-btn {
            background: #ff9900;
            color: white;
            animation: buttonGlow 2s infinite alternate;
        }

        .dark-mode-btn {
            background: #6c5ce7;
            color: white;
        }

        .style-btn:hover {
            transform: translateY(-2px);
        }

        .style-btn.active {
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
        }

        @keyframes buttonGlow {
            0% {
                box-shadow: 0 0 5px rgba(255, 153, 0, 0.5);
            }
            100% {
                box-shadow: 0 0 15px rgba(255, 204, 0, 0.8);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .video-item .download-video-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: var(--transition);
            min-height: 24px;
        }

        .video-item .download-video-btn:hover {
            transform: translateY(-2px);
        }

        .video-item .download-video-btn.downloaded {
            background: var(--success);
        }

        .downloaded-video-actions {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }

        .downloaded-edit-btn, .downloaded-delete-btn {
            padding: 4px 8px;
            border-radius: 4px;
            border: none;
            font-size: 7px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 3px;
            min-height: 22px;
        }

        .downloaded-edit-btn {
            background: var(--primary);
            color: white;
        }

        .downloaded-delete-btn {
            background: var(--danger);
            color: white;
        }

        .downloaded-edit-btn:hover, .downloaded-delete-btn:hover {
            transform: translateY(-2px);
        }

        .custom-image-upload-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--card-border);
            margin-top: 15px;
        }

        .custom-image-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .current-image-display {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            text-align: center;
        }

        .current-image-display img {
            width: 100%;
            height: auto;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            border: 2px solid var(--card-border);
        }

        .image-url-display {
            font-size: 8px;
            word-break: break-all;
            background: rgba(0, 0, 0, 0.1);
            padding: 6px;
            border-radius: 4px;
            margin-top: 8px;
        }

        .compact-password-section.small-state .form-input {
            width: 6px !important;
            height: 4px !important;
            padding: 0 !important;
            font-size: 0 !important;
            min-height: 4px !important;
            overflow: hidden;
        }

        .compact-password-section.small-state .submit-btn {
            width: 6px !important;
            height: 4px !important;
            padding: 0 !important;
            font-size: 0 !important;
            min-height: 4px !important;
            overflow: hidden;
        }

        .compact-password-section.small-state .form-title {
            font-size: 0 !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden;
            opacity: 0;
        }

        .compact-password-section.small-state .form-group {
            margin-bottom: 2px !important;
        }

        .compact-password-section.small-state .login-status {
            font-size: 0 !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden;
            opacity: 0;
        }

        /* Install Button */
        .install-button {
            position: fixed;
            bottom: 50px;
            right: 10px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            font-size: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(255, 153, 0, 0.3);
            display: none;
        }

        .install-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(255, 153, 0, 0.4);
        }

        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--danger);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 8px;
            font-weight: 600;
            z-index: 9998;
        }
    </style>
</head>
<body class="digital-mode">
    <div class="digital-bg"></div>
    <div class="digital-grid"></div>
    <div class="digital-particles" id="particles"></div>
    
    <div id="passwordTimerDisplay" class="password-timer-display" style="display: none;">
        <i class="fas fa-clock"></i> <span id="timerText">Password expires in: --:--:--</span>
    </div>
    
    <div class="app-footer">Created by // M-Sinwa</div>
    
    <div id="connectionStatus" class="connection-status online-status-badge" style="display: none;">
        <i class="fas fa-wifi"></i> Online
    </div>

    <!-- Install Button -->
    <button id="installButton" class="install-button">
        <i class="fas fa-download"></i> Install App
    </button>

    <div class="style-selector">
        <button class="style-btn normal-mode-btn" id="normalModeBtn">Normal</button>
        <button class="style-btn digital-mode-btn active" id="digitalModeBtn">Digital</button>
        <button class="style-btn dark-mode-btn" id="darkModeBtn">Dark</button>
    </div>

    <div id="noInternetModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeNoInternetModal"><i class="fas fa-times"></i></span>
            <h2 class="modal-title">No Internet Connection</h2>
            <p>You are currently offline. Some features may be limited.</p>
            <div class="btn-group" style="margin-top: 15px;">
                <button id="continueOfflineBtn" class="nav-btn"><i class="fas fa-play-circle"></i> Continue Offline</button>
            </div>
        </div>
    </div>

    <div id="editDownloadedModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeEditDownloadedModal"><i class="fas fa-times"></i></span>
            <h2 class="modal-title">Edit Downloaded Video</h2>
            <div class="form-group">
                <label class="form-label">Video Name</label>
                <input type="text" id="editDownloadedName" class="form-input" placeholder="Enter new video name">
            </div>
            <div class="form-group">
                <label class="form-label">Story Name</label>
                <input type="text" id="editDownloadedStory" class="form-input" placeholder="Enter story name (optional)">
            </div>
            <div class="form-group">
                <label class="form-label">Video Type</label>
                <select id="editDownloadedType" class="form-input">
                    <option value="cloudinary">Cloudinary</option>
                    <option value="youtube">YouTube</option>
                    <option value="telegram">Telegram</option>
                    <option value="hls">HLS Stream</option>
                    <option value="mp4">MP4 Video</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Notes (Optional)</label>
                <textarea id="editDownloadedNotes" class="form-input" placeholder="Add any notes about this video" rows="3"></textarea>
            </div>
            <button id="saveDownloadedEditBtn" class="submit-btn"><i class="fas fa-save"></i> Save Changes</button>
        </div>
    </div>

    <div id="screen1" class="screen active">
        <div class="container">
            <div class="top-bar">
                <div class="top-bar-left">
                    <div class="logo-container">
                        <div class="kachin-visions-logo">
                            <span class="kachin">Kachin</span>
                            <span class="visions"> Visions Empire</span>
                        </div>
                    </div>

                    <div class="compact-password-section" id="compactPasswordSection">
                        <h2 class="form-title"><i class="fas fa-lock"></i> Global Video Access</h2>
                        <div class="form-group">
                            <input type="password" id="password" class="form-input" placeholder="Enter your password">
                        </div>
                        <button id="unlockVideosBtn" class="submit-btn"><i class="fas fa-unlock"></i> Unlock All Video</button>
                        <p id="loginStatus" class="login-status">Please enter your password to unlock all videos</p>
                    </div>
                </div>

                <div class="story-password-row">
                    <div class="story-collection-menu">
                        <div class="story-menu-toggle" id="storyMenuToggle">
                            <i class="fas fa-film"></i> Story
                        </div>
                        <div id="storyMenu" class="story-menu">
                            <h3 class="story-menu-title">Story</h3>
                            <div id="storyList" class="story-list"></div>
                        </div>
                    </div>

                    <div id="storyPasswordSection" class="story-password-section">
                        <h3 class="form-title">Enter Password for <span id="selectedStoryName"></span></h3>
                        <div class="form-group">
                            <input type="password" id="storyPassword" class="form-input" placeholder="Enter story password">
                        </div>
                        <button id="unlockStoryBtn" class="submit-btn"><i class="fas fa-unlock"></i> Unlock Story</button>
                        <p id="storyPasswordStatus" class="login-status"></p>
                    </div>
                </div>
            </div>

            <div class="video-section">
                <div class="main-video-container">
                    <div id="mainVideoPlayer" class="video-player">
                        <div class="video-player-wrapper">
                            <div id="topBlackBar" class="black-bars top-bar" style="height: 0px;"></div>
                            <div class="video-content">
                                <video id="mainVideoElement" controls autoplay muted loop controlsList="nodownload noremoteplayback" style="width: 100%; height: 100%; object-fit: contain;" oncontextmenu="return false;">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                            <div id="bottomBlackBar" class="black-bars bottom-bar" style="height: 0px;"></div>
                        </div>
                    </div>
                </div>
                <div class="video-list-container">
                    <h3 class="video-list-title"><i class="fas fa-film"></i> Video Library</h3>
                    
                    <div id="videoList" class="video-list"></div>
                    
                    <div class="admin-message-container">
                        <h2 class="admin-message-title"><i class="fas fa-bullhorn"></i> Admin Announcements</h2>
                        <div id="adminMessageContent" class="admin-message-content"></div>
                    </div>

                    <div class="downloaded-videos-section" id="downloadedVideosSection" style="display: none;">
                        <h3 class="video-list-title"><i class="fas fa-download"></i> Downloaded Videos (Offline)</h3>
                        <div id="downloadedVideosList" class="video-list"></div>
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <button id="showContactLinksScreen" class="nav-btn"><i class="fas fa-film"></i> Old Movie Stories</button>
            </div>

            <div class="btn-group">
                <button id="adminLoginBtn" class="nav-btn" style="display: none;"><i class="fas fa-user-shield"></i> Admin Login</button>
            </div>
        </div>
    </div>

    <div id="screen4" class="screen">
        <div class="container">
            <div class="back-btn-container">
                <button id="backToScreen1FromContacts" class="back-btn"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            
            <div class="top-bar">
                <div class="top-bar-left">
                    <div class="logo-container">
                        <div class="kachin-visions-logo">
                            <span class="kachin">Kachin</span>
                            <span class="visions"> Visions Empire</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-container">
                <h2 class="form-title"><i class="fas fa-address-book"></i> Contact Links</h2>
                <div id="contactLinksScreenList"></div>
            </div>
        </div>
    </div>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function(registration) {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCJGR8dXeawpg6RNpF1iUC7TD65RWm-oxE",
            authDomain: "sun-day-video-production-298c8.firebaseapp.com",
            projectId: "sun-day-video-production-298c8",
            storageBucket: "sun-day-video-production-298c8.firebasestorage.app",
            messagingSenderId: "927333523323",
            appId: "1:927333523323:web:16375e95732c5acb4767de",
            measurementId: "G-ZY2Y2Y749H"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();
        const storage = firebase.storage();

        const screens = document.querySelectorAll('.screen');
        const screen1 = document.getElementById('screen1');
        const screen4 = document.getElementById('screen4');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const videoList = document.getElementById('videoList');
        const mainVideoPlayer = document.getElementById('mainVideoPlayer');
        const mainVideoElement = document.getElementById('mainVideoElement');
        const unlockVideosBtn = document.getElementById('unlockVideosBtn');
        const loginStatus = document.getElementById('loginStatus');
        const storyMenuToggle = document.getElementById('storyMenuToggle');
        const storyMenu = document.getElementById('storyMenu');
        const storyList = document.getElementById('storyList');
        const storyPasswordSection = document.getElementById('storyPasswordSection');
        const storyPassword = document.getElementById('storyPassword');
        const unlockStoryBtn = document.getElementById('unlockStoryBtn');
        const storyPasswordStatus = document.getElementById('storyPasswordStatus');
        const selectedStoryName = document.getElementById('selectedStoryName');
        const showContactLinksScreen = document.getElementById('showContactLinksScreen');
        const backToScreen1FromContacts = document.getElementById('backToScreen1FromContacts');
        const downloadedVideosSection = document.getElementById('downloadedVideosSection');
        const downloadedVideosList = document.getElementById('downloadedVideosList');
        const contactLinksScreenList = document.getElementById('contactLinksScreenList');
        const adminMessageContent = document.getElementById('adminMessageContent');
        const connectionStatus = document.getElementById('connectionStatus');
        const passwordTimerDisplay = document.getElementById('passwordTimerDisplay');
        const timerText = document.getElementById('timerText');
        const compactPasswordSection = document.getElementById('compactPasswordSection');
        const noInternetModal = document.getElementById('noInternetModal');
        const continueOfflineBtn = document.getElementById('continueOfflineBtn');
        const closeNoInternetModal = document.getElementById('closeNoInternetModal');
        const editDownloadedModal = document.getElementById('editDownloadedModal');
        const closeEditDownloadedModal = document.getElementById('closeEditDownloadedModal');
        const editDownloadedName = document.getElementById('editDownloadedName');
        const editDownloadedStory = document.getElementById('editDownloadedStory');
        const editDownloadedType = document.getElementById('editDownloadedType');
        const editDownloadedNotes = document.getElementById('editDownloadedNotes');
        const saveDownloadedEditBtn = document.getElementById('saveDownloadedEditBtn');
        const normalModeBtn = document.getElementById('normalModeBtn');
        const digitalModeBtn = document.getElementById('digitalModeBtn');
        const darkModeBtn = document.getElementById('darkModeBtn');
        const installButton = document.getElementById('installButton');

        let videos = [];
        let stories = [];
        let contactLinksData = [];
        let currentVideoElement = null;
        let hls = null;
        let isUserLoggedIn = false;
        let currentSelectedStory = null;
        let unlockedStories = [];
        let passwords = [];
        let monthlyPasswords = [];
        let timeBasedPasswords = {};
        let activeTimePassword = null;
        let passwordExpirationTimer = null;
        let currentDeviceId = '';
        let userSessionRef = null;
        let isOfflineMode = false;
        let downloadingVideos = new Set();
        let downloadProgress = {};
        let currentlyEditingDownloadedVideoId = null;
        let passwordBoxSizeTimer = null;
        let isPasswordBoxSmall = true;
        let adminMessageData = {
            content: '',
            timestamp: null
        };
        let customApplicationImageUrl = "https://res.cloudinary.com/zaumaran/image/upload/v1764932924/Kachin_Vision_Empire_For_Logo_zpkdbg.png";
        let deferredPrompt = null;

        const APP_FOLDER_NAME = 'Kachin Visions Empire';
        const VIDEO_FOLDER_NAME = 'videos';
        let appStorage = null;

        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'flex';
        });

        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('User accepted the install prompt');
                installButton.style.display = 'none';
            } else {
                console.log('User dismissed the install prompt');
            }
            
            deferredPrompt = null;
        });

        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            installButton.style.display = 'none';
            deferredPrompt = null;
        });

        async function initApp() {
            currentDeviceId = generateDeviceId();
            
            setStyleMode('digital');
            loadCustomImage();
            await initSecureDownloadSystem();
            
            auth.onAuthStateChanged(user => {
                if (user && user.email === 'sunday@video.com') {
                }
            });

            await loadVideos();
            await loadPasswords();
            await loadMonthlyPasswords();
            await loadTimePasswords();
            await loadContactLinks();
            
            setDefaultImageAsVideo();
            cacheVideosForOffline();
            checkOfflineVideos();
            checkActiveTimePassword();
            checkActiveMonthlyPassword();
            
            initPasswordBoxSizeManagement();
            initAutoRememberSystem();
            initDownloadedVideoEditModal();
            
            renderDownloadedVideosSection();
            
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            updateConnectionStatus();
            
            initDigitalEffects();
        }

        function setDefaultImageAsVideo() {
            mainVideoPlayer.innerHTML = '';
            
            const videoPlayerWrapper = document.createElement('div');
            videoPlayerWrapper.className = 'video-player-wrapper';
            
            const topBar = document.createElement('div');
            topBar.id = 'topBlackBar';
            topBar.className = 'black-bars top-bar';
            topBar.style.height = '0px';
            
            const bottomBar = document.createElement('div');
            bottomBar.id = 'bottomBlackBar';
            bottomBar.className = 'black-bars bottom-bar';
            bottomBar.style.height = '0px';
            
            const videoContent = document.createElement('div');
            videoContent.className = 'video-content';
            videoContent.style.height = '100%';
            
            const imgElement = document.createElement('img');
            imgElement.id = 'defaultImageElement';
            imgElement.src = customApplicationImageUrl;
            imgElement.alt = 'Kachin Visions Empire';
            imgElement.style.width = '100%';
            imgElement.style.height = '100%';
            imgElement.style.objectFit = 'contain';
            imgElement.style.objectPosition = 'center';
            
            videoContent.appendChild(imgElement);
            
            videoPlayerWrapper.appendChild(topBar);
            videoPlayerWrapper.appendChild(videoContent);
            videoPlayerWrapper.appendChild(bottomBar);
            mainVideoPlayer.appendChild(videoPlayerWrapper);
            
            currentVideoElement = imgElement;
        }

        function loadCustomImage() {
            const savedImageUrl = localStorage.getItem('customApplicationImageUrl');
            if (savedImageUrl) {
                customApplicationImageUrl = savedImageUrl;
            }
        }

        function initDigitalEffects() {
            createEnhancedParticles();
            
            digitalModeBtn.addEventListener('click', () => {
                setTimeout(createEnhancedParticles, 100);
            });
        }

        function createEnhancedParticles() {
            if (!document.body.classList.contains('digital-mode')) {
                return;
            }
            
            const particlesContainer = document.querySelector('.digital-particles');
            if (!particlesContainer) return;
            
            particlesContainer.innerHTML = '';
            
            for (let i = 0; i < 5; i++) {
                const sunParticle = document.createElement('div');
                sunParticle.className = 'particle sun';
                sunParticle.style.width = `${Math.random() * 40 + 20}px`;
                sunParticle.style.height = sunParticle.style.width;
                sunParticle.style.left = `${Math.random() * 100}%`;
                sunParticle.style.top = `${Math.random() * 100}%`;
                sunParticle.style.animationDuration = `${Math.random() * 20 + 10}s`;
                sunParticle.style.animationDelay = `${Math.random() * 5}s`;
                particlesContainer.appendChild(sunParticle);
            }
            
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = `${Math.random() * 10 + 2}px`;
                particle.style.height = particle.style.width;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.animationDuration = `${Math.random() * 15 + 5}s`;
                particle.style.animationDelay = `${Math.random() * 3}s`;
                particlesContainer.appendChild(particle);
            }
        }

        async function initSecureDownloadSystem() {
            try {
                if ('showDirectoryPicker' in window) {
                    try {
                        const handle = await window.showDirectoryPicker({
                            id: 'kachin-visions-empire-video-storage',
                            mode: 'readwrite',
                            startIn: 'documents'
                        });
                        
                        if (handle.name !== APP_FOLDER_NAME) {
                            appStorage = await handle.getDirectoryHandle(APP_FOLDER_NAME, { create: true });
                        } else {
                            appStorage = handle;
                        }
                        
                        await appStorage.getDirectoryHandle(VIDEO_FOLDER_NAME, { create: true });
                    } catch (error) {
                        console.warn('File System Access API not available or permission denied:', error);
                        appStorage = null;
                    }
                } else {
                    console.warn('File System Access API not supported in this browser');
                    appStorage = null;
                }
            } catch (error) {
                console.error('Error initializing secure download system:', error);
                appStorage = null;
            }
        }

        function generateDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', deviceId);
                registerInstallation(deviceId);
            }
            return deviceId;
        }

        function registerInstallation(deviceId) {
            if (navigator.onLine && !isOfflineMode) {
                const userAgent = navigator.userAgent;
                let deviceType = 'Unknown';
                
                if (/Android/.test(userAgent)) {
                    deviceType = 'Android';
                } else if (/iPhone|iPad|iPod/.test(userAgent)) {
                    deviceType = 'iOS';
                } else if (/Windows/.test(userAgent)) {
                    deviceType = 'Windows';
                } else if (/Mac/.test(userAgent)) {
                    deviceType = 'Mac';
                } else if (/Linux/.test(userAgent)) {
                    deviceType = 'Linux';
                }
                
                db.collection('installations').doc(deviceId).set({
                    deviceType: deviceType,
                    userAgent: userAgent,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    online: true,
                    lastSeen: new Date().toISOString()
                }).catch(error => {
                    console.error('Error registering installation:', error);
                });
            }
        }

        function setPasswordBoxSmall() {
            if (!compactPasswordSection) return;
            
            compactPasswordSection.classList.add('small-state');
            isPasswordBoxSmall = true;
            
            if (passwordBoxSizeTimer) {
                clearTimeout(passwordBoxSizeTimer);
                passwordBoxSizeTimer = null;
            }
        }

        function setPasswordBoxNormal() {
            if (!compactPasswordSection) return;
            
            compactPasswordSection.classList.remove('small-state');
            isPasswordBoxSmall = false;
            
            passwordBoxSizeTimer = setTimeout(() => {
                setPasswordBoxSmall();
            }, 10000);
        }

        function initPasswordBoxSizeManagement() {
            setPasswordBoxSmall();
            
            const passwordInput = document.getElementById('password');
            const unlockVideosBtn = document.getElementById('unlockVideosBtn');
            
            if (passwordInput) {
                passwordInput.addEventListener('focus', () => {
                    setPasswordBoxNormal();
                });
                
                passwordInput.addEventListener('click', () => {
                    setPasswordBoxNormal();
                });
                
                passwordInput.addEventListener('input', () => {
                    setPasswordBoxNormal();
                });
            }
            
            if (unlockVideosBtn) {
                unlockVideosBtn.addEventListener('click', () => {
                    setPasswordBoxNormal();
                });
                
                unlockVideosBtn.addEventListener('mouseenter', () => {
                    setPasswordBoxNormal();
                });
            }
            
            if (compactPasswordSection) {
                compactPasswordSection.addEventListener('mouseenter', () => {
                    setPasswordBoxNormal();
                });
            }
        }

        function showStoryPasswordSectionWithTimer(story) {
            currentSelectedStory = story;
            selectedStoryName.textContent = story;
            storyPasswordSection.classList.add('active');
            
            setTimeout(() => {
                if (storyPasswordSection.classList.contains('active')) {
                    storyPasswordSection.classList.remove('active');
                }
            }, 10000);
        }

        function rememberPassword(passwordType, password, additionalData = {}) {
            let rememberedPasswords = JSON.parse(localStorage.getItem('rememberedPasswords') || '{}');
            
            const passwordData = {
                password: password,
                timestamp: new Date().toISOString(),
                expiry: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                ...additionalData,
                passwordId: additionalData.passwordId || null
            };
            
            rememberedPasswords[passwordType] = rememberedPasswords[passwordType] || {};
            
            if (passwordType === 'story' && additionalData.storyName) {
                rememberedPasswords.story[additionalData.storyName] = passwordData;
            } else {
                rememberedPasswords[passwordType] = passwordData;
            }
            
            localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
            
            schedulePasswordCleanup(passwordType, additionalData.storyName, passwordData.expiry);
        }

        function schedulePasswordCleanup(passwordType, storyName, expiry) {
            const expiryTime = new Date(expiry).getTime() - Date.now();
            
            if (expiryTime > 0) {
                setTimeout(() => {
                    clearExpiredRememberedPasswords();
                    
                    if (passwordType === 'story' && storyName) {
                        lockStoryVideos(storyName);
                    } else if (passwordType === 'global' || passwordType === 'monthly' || passwordType === 'time') {
                        lockTimeBasedContent();
                    }
                }, expiryTime);
            }
        }

        function checkAndAutoFillPasswords() {
            const rememberedPasswords = JSON.parse(localStorage.getItem('rememberedPasswords') || '{}');
            const now = new Date();
            
            if (rememberedPasswords.global && new Date(rememberedPasswords.global.expiry) > now) {
                document.getElementById('password').value = rememberedPasswords.global.password;
            }
            
            if (rememberedPasswords.story && currentSelectedStory) {
                const storyPasswordData = rememberedPasswords.story[currentSelectedStory];
                if (storyPasswordData && new Date(storyPasswordData.expiry) > now) {
                    document.getElementById('storyPassword').value = storyPasswordData.password;
                }
            }
            
            if (rememberedPasswords.monthly && new Date(rememberedPasswords.monthly.expiry) > now) {
                document.getElementById('password').value = rememberedPasswords.monthly.password;
            }
        }

        function clearExpiredRememberedPasswords() {
            const rememberedPasswords = JSON.parse(localStorage.getItem('rememberedPasswords') || '{}');
            const now = new Date();
            let hasChanges = false;
            
            if (rememberedPasswords.global && new Date(rememberedPasswords.global.expiry) <= now) {
                delete rememberedPasswords.global;
                hasChanges = true;
            }
            
            if (rememberedPasswords.story) {
                Object.keys(rememberedPasswords.story).forEach(storyName => {
                    if (new Date(rememberedPasswords.story[storyName].expiry) <= now) {
                        delete rememberedPasswords.story[storyName];
                        hasChanges = true;
                    }
                });
                
                if (Object.keys(rememberedPasswords.story).length === 0) {
                    delete rememberedPasswords.story;
                    hasChanges = true;
                }
            }
            
            if (rememberedPasswords.monthly && new Date(rememberedPasswords.monthly.expiry) <= now) {
                delete rememberedPasswords.monthly;
                hasChanges = true;
            }
            
            if (hasChanges) {
                localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
            }
        }

        function setupAdminPasswordDeletionListener() {
            if (navigator.onLine && !isOfflineMode) {
                db.collection('passwords').onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'removed') {
                            const deletedPasswordId = change.doc.id;
                            
                            const rememberedPasswords = JSON.parse(localStorage.getItem('rememberedPasswords') || '{}');
                            let passwordToRemove = null;
                            
                            if (rememberedPasswords.global && rememberedPasswords.global.password === deletedPasswordId) {
                                passwordToRemove = 'global';
                            }
                            
                            if (rememberedPasswords.story) {
                                Object.keys(rememberedPasswords.story).forEach(storyName => {
                                    if (rememberedPasswords.story[storyName].password === deletedPasswordId) {
                                        passwordToRemove = `story.${storyName}`;
                                    }
                                });
                            }
                            
                            if (passwordToRemove) {
                                if (passwordToRemove === 'global') {
                                    delete rememberedPasswords.global;
                                } else if (passwordToRemove.startsWith('story.')) {
                                    const storyName = passwordToRemove.split('.')[1];
                                    delete rememberedPasswords.story[storyName];
                                }
                                
                                localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
                                
                                if (passwordToRemove.startsWith('story.')) {
                                    const storyName = passwordToRemove.split('.')[1];
                                    lockStoryVideos(storyName);
                                }
                            }
                        }
                    });
                });
                
                db.collection('monthlyPasswords').onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'removed') {
                            const deletedPasswordId = change.doc.id;
                            
                            const rememberedPasswords = JSON.parse(localStorage.getItem('rememberedPasswords') || '{}');
                            
                            if (rememberedPasswords.monthly && rememberedPasswords.monthly.password === deletedPasswordId) {
                                delete rememberedPasswords.monthly;
                                localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
                                
                                lockTimeBasedContent();
                            }
                        }
                    });
                });
            }
        }

        function initAutoRememberSystem() {
            clearExpiredRememberedPasswords();
            
            document.getElementById('storyList').addEventListener('click', function(e) {
                if (e.target.classList.contains('story-item')) {
                    setTimeout(checkAndAutoFillPasswords, 100);
                }
            });
            
            window.addEventListener('load', function() {
                setTimeout(checkAndAutoFillPasswords, 500);
            });
            
            setupAdminPasswordDeletionListener();
        }

        function renderDownloadedVideosSection() {
            const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
            
            if (Object.keys(downloadedVideos).length === 0) {
                downloadedVideosSection.style.display = 'none';
                return;
            }
            
            downloadedVideosSection.style.display = 'block';
            downloadedVideosList.innerHTML = '';
            
            Object.entries(downloadedVideos).forEach(([videoId, videoData]) => {
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item downloaded';
                
                const expiresDate = new Date(videoData.expires);
                const daysLeft = Math.ceil((expiresDate - new Date()) / (1000 * 60 * 60 * 24));
                
                const customName = videoData.customName || videoData.name;
                const customStory = videoData.customStory || videoData.storyName;
                const customType = videoData.customType || videoData.type;
                const notes = videoData.notes || '';
                
                videoItem.innerHTML = `
                    <div style="flex: 1;">
                        <h4 style="font-size: 9px;">${customName}</h4>
                        <p style="font-size: 8px;">${customType} ${customStory ? ` ${customStory}` : ''}</p>
                        <p style="font-size: 8px; color: var(--accent);">
                            <i class="fas fa-clock"></i> Expires in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}
                        </p>
                        ${notes ? `<p style="font-size: 7px; color: var(--gray); margin-top: 2px;"><i class="fas fa-sticky-note"></i> ${notes}</p>` : ''}
                        <div class="downloaded-video-actions">
                            <button class="downloaded-edit-btn" data-id="${videoId}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="downloaded-delete-btn" data-id="${videoId}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    <button class="play-offline-btn" data-id="${videoId}" style="
                        background: var(--success);
                        color: white;
                        border: none;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 8px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    ">
                        <i class="fas fa-play"></i> Play
                    </button>
                `;
                
                videoItem.addEventListener('click', async (e) => {
                    if (e.target.closest('.play-offline-btn') || 
                        e.target.closest('.downloaded-edit-btn') || 
                        e.target.closest('.downloaded-delete-btn')) return;
                    await playOfflineVideo(videoId);
                });
                
                const playBtn = videoItem.querySelector('.play-offline-btn');
                playBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await playOfflineVideo(videoId);
                });
                
                const editBtn = videoItem.querySelector('.downloaded-edit-btn');
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditDownloadedModal(videoId, videoData);
                });
                
                const deleteBtn = videoItem.querySelector('.downloaded-delete-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteDownloadedVideo(videoId);
                });
                
                downloadedVideosList.appendChild(videoItem);
            });
        }

        function openEditDownloadedModal(videoId, videoData) {
            currentlyEditingDownloadedVideoId = videoId;
            
            editDownloadedName.value = videoData.customName || videoData.name || '';
            editDownloadedStory.value = videoData.customStory || videoData.storyName || '';
            editDownloadedType.value = videoData.customType || videoData.type || 'mp4';
            editDownloadedNotes.value = videoData.notes || '';
            
            editDownloadedModal.style.display = 'flex';
        }

        function saveDownloadedVideoEdit() {
            const videoId = currentlyEditingDownloadedVideoId;
            if (!videoId) return;
            
            const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
            const videoData = downloadedVideos[videoId];
            
            if (!videoData) {
                alert('Video not found!');
                return;
            }
            
            const newName = editDownloadedName.value.trim();
            const newStory = editDownloadedStory.value.trim();
            const newType = editDownloadedType.value;
            const newNotes = editDownloadedNotes.value.trim();
            
            if (!newName) {
                alert('Video name is required!');
                return;
            }
            
            videoData.customName = newName;
            if (newStory) videoData.customStory = newStory;
            if (newType) videoData.customType = newType;
            if (newNotes) videoData.notes = newNotes;
            videoData.lastEdited = new Date().toISOString();
            
            downloadedVideos[videoId] = videoData;
            localStorage.setItem('downloadedVideos', JSON.stringify(downloadedVideos));
            
            editDownloadedModal.style.display = 'none';
            currentlyEditingDownloadedVideoId = null;
            
            renderDownloadedVideosSection();
            renderVideoLibraryWithDownloads();
            
            alert('Video information updated successfully!');
        }

        function deleteDownloadedVideo(videoId) {
            if (!confirm('Are you sure you want to delete this downloaded video? This action cannot be undone.')) {
                return;
            }
            
            const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
            
            if (!downloadedVideos[videoId]) {
                alert('Video not found!');
                return;
            }
            
            delete downloadedVideos[videoId];
            localStorage.setItem('downloadedVideos', JSON.stringify(downloadedVideos));
            
            const cachedVideos = JSON.parse(localStorage.getItem('cachedVideos') || '[]');
            const updatedCachedVideos = cachedVideos.filter(v => v.id !== videoId);
            localStorage.setItem('cachedVideos', JSON.stringify(updatedCachedVideos));
            
            renderDownloadedVideosSection();
            renderVideoLibraryWithDownloads();
            
            alert('Video deleted successfully! Storage space has been freed up.');
        }

        function initDownloadedVideoEditModal() {
            closeEditDownloadedModal.addEventListener('click', () => {
                editDownloadedModal.style.display = 'none';
                currentlyEditingDownloadedVideoId = null;
            });
            
            saveDownloadedEditBtn.addEventListener('click', saveDownloadedVideoEdit);
            
            editDownloadedModal.addEventListener('click', (e) => {
                if (e.target === editDownloadedModal) {
                    editDownloadedModal.style.display = 'none';
                    currentlyEditingDownloadedVideoId = null;
                }
            });
        }

        async function loadVideos() {
            try {
                if (navigator.onLine && !isOfflineMode) {
                    const snapshot = await db.collection('videos').get();
                    videos = [];
                    snapshot.forEach(doc => {
                        videos.push({ id: doc.id, ...doc.data() });
                    });
                    
                    videos.sort((a, b) => {
                        if (a.storyName && b.storyName) {
                            if (a.storyName.toLowerCase() < b.storyName.toLowerCase()) return -1;
                            if (a.storyName.toLowerCase() > b.storyName.toLowerCase()) return 1;
                        }
                        
                        if (a.name.toLowerCase() < b.name.toLowerCase()) return -1;
                        if (a.name.toLowerCase() > b.name.toLowerCase()) return 1;
                        return 0;
                    });
                    
                    await renderVideoList();
                    loadStories();
                    updateDownloadableVideos();
                    cacheVideosForOffline();
                } else {
                    await loadCachedVideos();
                    await renderVideoList();
                }
            } catch (error) {
                console.error('Error loading videos:', error);
                await renderVideoList();
            }
        }

        function updateDownloadableVideos() {
            const downloadableVideos = videos.filter(v => v.downloadable === true);
            localStorage.setItem('downloadableVideos', JSON.stringify(downloadableVideos));
            renderVideoLibraryWithDownloads();
        }

        function renderVideoLibraryWithDownloads() {
            videoList.innerHTML = '';
            
            const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
            
            let videosToDisplay = [...videos];
            
            videosToDisplay.sort((a, b) => {
                if (a.downloadable && !b.downloadable) return -1;
                if (!a.downloadable && b.downloadable) return 1;
                return a.name.localeCompare(b.name);
            });
            
            videosToDisplay.forEach(video => {
                renderVideoItem(video, downloadedVideos);
            });
        }

        function renderVideoItem(video, downloadedVideos) {
            const videoItem = document.createElement('div');
            
            const isFree = video.passwordType === 'free';
            const isUnlocked = isUserLoggedIn || 
                (video.storyName && unlockedStories.includes(video.storyName)) ||
                activeTimePassword;
            
            const isDownloadable = video.downloadable === true;
            const isDownloaded = downloadedVideos[video.id];
            
            if ((isFree || isUnlocked) && isDownloadable) {
                videoItem.className = 'video-item downloadable';
            } else if (isFree) {
                videoItem.className = 'video-item free';
            } else if (!isUnlocked) {
                videoItem.className = 'video-item locked';
            } else {
                videoItem.className = 'video-item';
            }
            
            videoItem.innerHTML = `
                <div style="flex: 1;">
                    <h4 style="font-size: 9px;">${video.name}</h4>
                    <p style="font-size: 8px;">${video.type} ${video.storyName ? ` ${video.storyName}` : ''}</p>
                    ${isDownloadable ? '<p style="font-size: 8px; color: var(--success);"><i class="fas fa-download"></i> Download Available</p>' : ''}
                    ${isDownloaded ? '<p style="font-size: 8px; color: var(--accent);"><i class="fas fa-check-circle"></i> Downloaded</p>' : ''}
                </div>
                ${isFree ? '<span class="free-badge">Free</span>' : ''}
                ${isDownloadable && (isFree || isUnlocked) ? 
                    `<button class="download-video-btn" data-id="${video.id}" style="
                        background: ${isDownloaded ? 'var(--success)' : 'var(--primary)'};
                        color: white;
                        border: none;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 8px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    ">
                        <i class="fas ${isDownloaded ? 'fa-check' : 'fa-download'}"></i>
                        ${isDownloaded ? 'Downloaded' : 'Save'}
                    </button>` : ''
                }
            `;
            
            videoItem.addEventListener('click', async (e) => {
                if (e.target.closest('.download-video-btn')) return;
                
                if (!videoItem.classList.contains('locked')) {
                    await playVideo(video);
                } else if (isFree) {
                    await playVideo(video);
                } else {
                    alert('This video requires a password. Please enter the password for this story or use the global password.');
                }
            });
            
            if (isDownloadable && (isFree || isUnlocked)) {
                const downloadBtn = videoItem.querySelector('.download-video-btn');
                downloadBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await downloadVideoForOffline(video);
                });
            }
            
            videoList.appendChild(videoItem);
        }

        async function downloadVideoForOffline(video) {
            if (!video.downloadable) {
                alert('This video is not available for download.');
                return;
            }
            
            if (downloadingVideos.has(video.id)) {
                alert('This video is already being downloaded.');
                return;
            }
            
            if (!await checkStorageQuota()) {
                alert('Insufficient storage space. Please free up some space and try again.');
                return;
            }
            
            const downloadBtn = document.querySelector(`.download-video-btn[data-id="${video.id}"]`);
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
            downloadBtn.disabled = true;
            downloadingVideos.add(video.id);
            
            try {
                const encryptedVideoData = await encryptVideoData(video);
                
                let storagePath = null;
                if (appStorage) {
                    try {
                        storagePath = await saveToSecureStorage(video.id, encryptedVideoData);
                    } catch (error) {
                        console.warn('Failed to save to secure storage:', error);
                    }
                }
                
                const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
                downloadedVideos[video.id] = {
                    ...video,
                    encryptedData: encryptedVideoData,
                    storagePath: storagePath,
                    downloadDate: new Date().toISOString(),
                    expires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                };
                
                localStorage.setItem('downloadedVideos', JSON.stringify(downloadedVideos));
                
                downloadBtn.innerHTML = '<i class="fas fa-check"></i> Downloaded';
                downloadBtn.style.background = 'var(--success)';
                
                alert('Video downloaded securely! You can now watch it offline.');
                
                renderVideoLibraryWithDownloads();
                renderDownloadedVideosSection();
                
                if (navigator.onLine && !isOfflineMode) {
                    await db.collection('videoDownloads').add({
                        videoId: video.id,
                        videoName: video.name,
                        storyName: video.storyName,
                        deviceId: currentDeviceId,
                        downloadDate: firebase.firestore.FieldValue.serverTimestamp(),
                        expires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)
                    });
                }
                
            } catch (error) {
                console.error('Error downloading video:', error);
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
                alert('Error downloading video. Please try again.');
            } finally {
                downloadingVideos.delete(video.id);
            }
        }

        async function saveToSecureStorage(videoId, encryptedData) {
            if (!appStorage) return null;
            
            try {
                const videosFolder = await appStorage.getDirectoryHandle(VIDEO_FOLDER_NAME, { create: true });
                
                const filename = `video_${videoId}_${currentDeviceId}.enc`;
                const fileHandle = await videosFolder.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                
                await writable.write(encryptedData);
                await writable.close();
                
                return filename;
            } catch (error) {
                console.error('Error saving to secure storage:', error);
                throw error;
            }
        }

        async function loadFromSecureStorage(filename) {
            if (!appStorage) return null;
            
            try {
                const videosFolder = await appStorage.getDirectoryHandle(VIDEO_FOLDER_NAME, { create: false });
                const fileHandle = await videosFolder.getFileHandle(filename, { create: false });
                const file = await fileHandle.getFile();
                return await file.text();
            } catch (error) {
                console.error('Error loading from secure storage:', error);
                return null;
            }
        }

        async function deleteFromSecureStorage(filename) {
            if (!appStorage) return;
            
            try {
                const videosFolder = await appStorage.getDirectoryHandle(VIDEO_FOLDER_NAME, { create: false });
                await videosFolder.removeEntry(filename);
            } catch (error) {
                console.error('Error deleting from secure storage:', error);
            }
        }

        async function encryptVideoData(video) {
            const secretKey = CryptoJS.SHA256(`${currentDeviceId}_${video.id}_kachin_visions_empire_secret`).toString();
            
            const encrypted = CryptoJS.AES.encrypt(
                JSON.stringify({
                    ...video,
                    _encrypted: true,
                    _deviceId: currentDeviceId,
                    _timestamp: new Date().toISOString(),
                    _app: 'Kachin Visions Empire'
                }),
                secretKey
            ).toString();
            
            return encrypted;
        }

        async function decryptVideoData(encryptedData) {
            try {
                const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
                let videoId = null;
                
                for (const [id, data] of Object.entries(downloadedVideos)) {
                    if (data.encryptedData === encryptedData || data.storagePath) {
                        videoId = id;
                        break;
                    }
                }
                
                if (!videoId) {
                    throw new Error('Video not found in downloaded videos');
                }
                
                const secretKey = CryptoJS.SHA256(`${currentDeviceId}_${videoId}_kachin_visions_empire_secret`).toString();
                
                const decryptedBytes = CryptoJS.AES.decrypt(encryptedData, secretKey);
                const decryptedText = decryptedBytes.toString(CryptoJS.enc.Utf8);
                
                if (!decryptedText) {
                    throw new Error('Decryption failed - invalid key or data');
                }
                
                const decrypted = JSON.parse(decryptedText);
                
                if (decrypted._deviceId !== currentDeviceId) {
                    throw new Error('Video not authorized for this device');
                }
                
                if (decrypted._app !== 'Kachin Visions Empire') {
                    throw new Error('Invalid video format');
                }
                
                delete decrypted._encrypted;
                delete decrypted._deviceId;
                delete decrypted._timestamp;
                delete decrypted._app;
                
                return decrypted;
            } catch (error) {
                console.error('Error decrypting video:', error);
                throw new Error('Failed to decrypt video data. It may be corrupted or not authorized for this device.');
            }
        }

        async function checkStorageQuota() {
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                try {
                    const { usage, quota } = await navigator.storage.estimate();
                    const availableSpace = quota - usage;
                    const minRequired = 50 * 1024 * 1024;
                    
                    return availableSpace > minRequired;
                } catch (error) {
                    console.error('Error checking storage quota:', error);
                    return true;
                }
            }
            return true;
        }

        async function playOfflineVideo(videoId) {
            const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
            const videoData = downloadedVideos[videoId];
            
            if (!videoData) {
                alert('Video not found in offline storage.');
                return;
            }
            
            if (videoData.expires && new Date(videoData.expires) < new Date()) {
                delete downloadedVideos[videoId];
                localStorage.setItem('downloadedVideos', JSON.stringify(downloadedVideos));
                
                if (videoData.storagePath) {
                    await deleteFromSecureStorage(videoData.storagePath);
                }
                
                alert('This downloaded video has expired. Please download it again.');
                renderVideoLibraryWithDownloads();
                renderDownloadedVideosSection();
                return;
            }
            
            try {
                let encryptedData = videoData.encryptedData;
                if (videoData.storagePath && !encryptedData) {
                    encryptedData = await loadFromSecureStorage(videoData.storagePath);
                    if (!encryptedData) {
                        throw new Error('Could not load video from secure storage');
                    }
                }
                
                const decryptedVideo = await decryptVideoData(encryptedData);
                
                await playVideo(decryptedVideo);
                
            } catch (error) {
                console.error('Error playing offline video:', error);
                alert('Error playing offline video. It may be corrupted or not authorized for this device.');
            }
        }

        async function loadCachedVideos() {
            try {
                const cachedVideos = JSON.parse(localStorage.getItem('cachedVideos') || '[]');
                videos = cachedVideos;
            } catch (error) {
                console.error('Error loading cached videos:', error);
                videos = [];
            }
        }

        function cacheVideosForOffline() {
            if (navigator.onLine && !isOfflineMode) {
                const videoCache = videos.map(v => ({
                    id: v.id,
                    name: v.name,
                    storyName: v.storyName,
                    type: v.type,
                    passwordType: v.passwordType,
                    downloadable: v.downloadable || false,
                    added: v.added
                }));
                
                localStorage.setItem('cachedVideos', JSON.stringify(videoCache));
            }
        }

        function loadStories() {
            stories = [];
            const storyMap = {};
            
            videos.forEach(video => {
                if (video.storyName && !storyMap[video.storyName]) {
                    storyMap[video.storyName] = true;
                    stories.push(video.storyName);
                }
            });
            
            renderStoryMenu();
        }

        function renderStoryMenu() {
            storyList.innerHTML = '';
            
            stories.forEach(story => {
                const storyItem = document.createElement('div');
                storyItem.className = 'story-item';
                storyItem.textContent = story;
                storyItem.addEventListener('click', () => {
                    selectStory(story);
                    storyMenu.classList.remove('active');
                });
                
                storyList.appendChild(storyItem);
            });
        }

        function selectStory(story) {
            currentSelectedStory = story;
            selectedStoryName.textContent = story;
            
            document.querySelectorAll('.story-item').forEach(item => {
                item.classList.remove('active');
                if (item.textContent === story) {
                    item.classList.add('active');
                }
            });
            
            checkAndAutoFillPasswords();
            
            const hasPasswordProtectedVideos = videos.some(video => 
                video.storyName === story && video.passwordType === 'password'
            );
            
            if (hasPasswordProtectedVideos && !unlockedStories.includes(story)) {
                showStoryPasswordSectionWithTimer(story);
                storyPasswordStatus.textContent = 'Enter password to unlock this story';
                storyPasswordStatus.style.color = 'var(--accent)';
            } else {
                storyPasswordSection.classList.remove('active');
                filterVideosByStory(story);
            }
        }

        function unlockStory() {
            const password = storyPassword.value;
            const story = currentSelectedStory;
            
            if (!password) {
                storyPasswordStatus.textContent = 'Please enter a password';
                storyPasswordStatus.style.color = 'var(--danger)';
                return;
            }
            
            const validPassword = passwords.find(p => 
                p.password === password && p.storyName === story
            );
            
            if (validPassword) {
                if (validPassword.singleDevice && validPassword.deviceId && validPassword.deviceId !== currentDeviceId) {
                    storyPasswordStatus.textContent = 'This password is already registered to another device.';
                    storyPasswordStatus.style.color = 'var(--danger)';
                    return;
                }
                
                unlockedStories.push(story);
                storyPasswordSection.classList.remove('active');
                storyPasswordStatus.textContent = '';
                filterVideosByStory(story);
                
                rememberPassword('story', password, { storyName: story });
                
                alert(`Story "${story}" unlocked successfully!`);
            } else {
                storyPasswordStatus.textContent = 'Invalid password for this story';
                storyPasswordStatus.style.color = 'var(--danger)';
            }
        }

        function filterVideosByStory(story) {
            renderVideoLibraryWithDownloads();
        }

        function lockStoryVideos(storyName) {
            const index = unlockedStories.indexOf(storyName);
            if (index !== -1) {
                unlockedStories.splice(index, 1);
            }
            
            document.querySelectorAll('.video-item').forEach(item => {
                const itemText = item.querySelector('p')?.textContent || '';
                if (itemText.includes(` ${storyName}`) || itemText.includes(storyName)) {
                    if (!item.classList.contains('free')) {
                        item.classList.add('locked');
                    }
                }
            });
            
            renderContactLinksScreen();
            
            if (isUserLoggedIn) {
                alert(`Access to story "${storyName}" has been revoked. Videos from this story are now locked.`);
            }
            
            if (unlockedStories.length === 0) {
                isUserLoggedIn = false;
                loginStatus.textContent = 'Please enter your password to unlock videos';
                loginStatus.style.color = 'var(--accent)';
            }
        }

        function loadPasswords() {
            if (navigator.onLine && !isOfflineMode) {
                db.collection('passwords').get().then(snapshot => {
                    passwords = [];
                    snapshot.forEach(doc => {
                        passwords.push({ id: doc.id, ...doc.data() });
                    });
                }).catch(error => {
                    console.error('Error loading passwords:', error);
                });
            }
        }

        function loadMonthlyPasswords() {
            if (navigator.onLine && !isOfflineMode) {
                db.collection('monthlyPasswords').get().then(snapshot => {
                    monthlyPasswords = [];
                    snapshot.forEach(doc => {
                        monthlyPasswords.push({ id: doc.id, ...doc.data() });
                    });
                }).catch(error => {
                    console.error('Error loading monthly passwords:', error);
                });
            }
        }

        function loadTimePasswords() {
            if (navigator.onLine && !isOfflineMode) {
                db.collection('timePasswords').get().then(snapshot => {
                    timeBasedPasswords = {};
                    snapshot.forEach(doc => {
                        timeBasedPasswords[doc.id] = doc.data();
                    });
                    
                    checkActiveTimePassword();
                }).catch(error => {
                    console.error('Error loading time passwords:', error);
                    checkActiveTimePassword();
                });
            } else {
                checkActiveTimePassword();
            }
        }

        function loadContactLinks() {
            if (navigator.onLine && !isOfflineMode) {
                db.collection('contactLinks').get().then(snapshot => {
                    contactLinksData = [];
                    snapshot.forEach(doc => {
                        contactLinksData.push({ id: doc.id, ...doc.data() });
                    });
                    
                    renderContactLinksScreen();
                }).catch(error => {
                    console.error('Error loading contact links:', error);
                    renderContactLinksScreen();
                });
            } else {
                renderContactLinksScreen();
            }
        }

        async function renderVideoList() {
            renderVideoLibraryWithDownloads();
        }

        async function playVideo(video) {
            if (hls) {
                hls.destroy();
                hls = null;
            }
            
            let videoUrl = video.url;
            
            const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
            const isDownloaded = downloadedVideos[video.id];
            
            if (!navigator.onLine && !isDownloaded) {
                alert('Video not available offline. Please download it first or connect to the internet.');
                return;
            }
            
            if (!navigator.onLine && isDownloaded) {
                try {
                    const decryptedVideo = await decryptVideoData(downloadedVideos[video.id].encryptedData);
                    videoUrl = decryptedVideo.url;
                } catch (error) {
                    alert('Error playing offline video. Please try downloading it again.');
                    return;
                }
            }
            
            mainVideoPlayer.innerHTML = '';
            
            const videoPlayerWrapper = document.createElement('div');
            videoPlayerWrapper.className = 'video-player-wrapper';
            
            const topBar = document.createElement('div');
            topBar.id = 'topBlackBar';
            topBar.className = 'black-bars top-bar';
            topBar.style.height = '0px';
            
            const bottomBar = document.createElement('div');
            bottomBar.id = 'bottomBlackBar';
            bottomBar.className = 'black-bars bottom-bar';
            bottomBar.style.height = '0px';
            
            const videoContent = document.createElement('div');
            videoContent.className = 'video-content';
            videoContent.style.height = '100%';
            
            if (video.type === 'youtube') {
                const videoId = extractYouTubeId(video.url);
                if (!videoId) {
                    alert('Invalid YouTube URL format');
                    return;
                }
                
                const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                
                const iframe = document.createElement('iframe');
                iframe.className = 'youtube-iframe';
                iframe.src = embedUrl;
                iframe.allowFullscreen = true;
                iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                iframe.referrerPolicy = 'strict-origin-when-cross-origin';
                iframe.frameBorder = '0';
                iframe.title = video.name;
                
                videoContent.appendChild(iframe);
                currentVideoElement = iframe;
            } else if (video.type === 'hls' && video.url && video.url.endsWith('.m3u8')) {
                if (Hls.isSupported()) {
                    const videoElement = document.createElement('video');
                    videoElement.id = 'mainVideoElement';
                    videoElement.controls = true;
                    videoElement.autoplay = true;
                    videoElement.muted = false;
                    videoElement.loop = false;
                    videoElement.controlsList = 'nodownload noremoteplayback';
                    videoElement.style.width = '100%';
                    videoElement.style.height = '100%';
                    videoElement.oncontextmenu = () => false;
                    
                    videoContent.appendChild(videoElement);
                    currentVideoElement = videoElement;
                    
                    hls = new Hls({
                        enableWorker: false,
                        lowLatencyMode: true,
                        backBufferLength: 90
                    });
                    
                    hls.loadSource(videoUrl);
                    hls.attachMedia(videoElement);
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        console.log('HLS manifest parsed successfully');
                    });
                } else if (mainVideoElement && mainVideoElement.canPlayType('application/vnd.apple.mpegurl')) {
                    mainVideoElement.src = videoUrl;
                    currentVideoElement = mainVideoElement;
                } else {
                    console.error('HLS is not supported in this browser');
                    alert('HLS video is not supported in your browser. Please try a different browser.');
                    return;
                }
            } else {
                const videoElement = document.createElement('video');
                videoElement.id = 'mainVideoElement';
                videoElement.controls = true;
                videoElement.autoplay = true;
                videoElement.muted = false;
                videoElement.loop = false;
                videoElement.controlsList = 'nodownload noremoteplayback';
                videoElement.style.width = '100%';
                videoElement.style.height = '100%';
                videoElement.oncontextmenu = () => false;
                
                const source = document.createElement('source');
                source.src = videoUrl;
                
                if (videoUrl.toLowerCase().endsWith('.webm')) {
                    source.type = 'video/webm';
                } else if (videoUrl.toLowerCase().endsWith('.ogg') || videoUrl.toLowerCase().endsWith('.ogv')) {
                    source.type = 'video/ogg';
                } else {
                    source.type = 'video/mp4';
                }
                
                videoElement.appendChild(source);
                videoElement.innerHTML += 'Your browser does not support the video tag.';
                
                videoContent.appendChild(videoElement);
                currentVideoElement = videoElement;
            }
            
            videoPlayerWrapper.appendChild(topBar);
            videoPlayerWrapper.appendChild(videoContent);
            videoPlayerWrapper.appendChild(bottomBar);
            mainVideoPlayer.appendChild(videoPlayerWrapper);
            
            document.querySelectorAll('.video-item').forEach(item => {
                item.classList.remove('playing');
            });
            
            const videoItems = document.querySelectorAll('.video-item');
            for (let i = 0; i < videoItems.length; i++) {
                const itemText = videoItems[i].querySelector('h4').textContent;
                if (itemText === video.name) {
                    videoItems[i].classList.add('playing');
                    break;
                }
            }

            if (currentVideoElement) {
                currentVideoElement.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    return false;
                });
            }
        }

        function extractYouTubeId(url) {
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&?#]+)/,
                /youtube\.com\/watch\?.*v=([^&?#]+)/,
                /youtu\.be\/([^&?#]+)/,
                /youtube\.com\/embed\/([^&?#]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        function unlockVideos() {
            const password = document.getElementById('password').value;
            
            if (!password) {
                loginStatus.textContent = 'Please enter a password';
                loginStatus.style.color = 'var(--danger)';
                return;
            }
            
            const validPassword = passwords.find(p => p.password === password);
            const validMonthlyPassword = monthlyPasswords.find(p => p.password === password);
            
            let validStoryPassword = null;
            if (!validPassword && !validMonthlyPassword) {
                const passwordParts = password.split('.');
                if (passwordParts.length >= 2) {
                    const lastPart = passwordParts[passwordParts.length - 1];
                    if (/^\d{6}$/.test(lastPart)) {
                        validStoryPassword = passwords.find(p => p.password === password);
                    }
                }
            }
            
            if (validPassword || validStoryPassword) {
                const passwordToUse = validPassword || validStoryPassword;
                const storyName = passwordToUse.storyName;
                
                if (passwordToUse.singleDevice && passwordToUse.deviceId && passwordToUse.deviceId !== currentDeviceId) {
                    loginStatus.textContent = 'This password is already registered to another device. Single device access only.';
                    loginStatus.style.color = 'var(--danger)';
                    return;
                }
                
                if (navigator.onLine && !isOfflineMode) {
                    const passwordRef = db.collection('passwords').doc(passwordToUse.id);
                    
                    passwordRef.update({
                        deviceId: currentDeviceId,
                        loginTime: new Date().toISOString(),
                        online: true,
                        startTime: new Date().toISOString(),
                        used: true
                    }).then(() => {
                        passwordToUse.deviceId = currentDeviceId;
                        passwordToUse.loginTime = new Date().toISOString();
                        passwordToUse.online = true;
                        passwordToUse.startTime = new Date().toISOString();
                        passwordToUse.used = true;
                        
                        completeStoryPasswordUnlockProcess(password, storyName);
                    }).catch(error => {
                        console.error('Error updating password device info:', error);
                        alert('Error unlocking videos. Please try again.');
                    });
                } else {
                    passwordToUse.deviceId = currentDeviceId;
                    passwordToUse.loginTime = new Date().toISOString();
                    passwordToUse.online = false;
                    passwordToUse.startTime = new Date().toISOString();
                    passwordToUse.used = true;
                    
                    completeStoryPasswordUnlockProcess(password, storyName);
                }
            } else if (validMonthlyPassword) {
                if (validMonthlyPassword.singleDevice && validMonthlyPassword.deviceId && validMonthlyPassword.deviceId !== currentDeviceId) {
                    loginStatus.textContent = 'This password is already registered to another device. Single device access only.';
                    loginStatus.style.color = 'var(--danger)';
                    return;
                }
                
                if (validMonthlyPassword.expirationDate) {
                    const expirationDate = validMonthlyPassword.expirationDate.toDate
                        ? validMonthlyPassword.expirationDate.toDate()
                        : new Date(validMonthlyPassword.expirationDate);
                    
                    if (new Date() > expirationDate) {
                        loginStatus.textContent = 'This password has expired.';
                        loginStatus.style.color = 'var(--danger)';
                        return;
                    }
                }
                
                if (navigator.onLine && !isOfflineMode) {
                    const passwordRef = db.collection('monthlyPasswords').doc(validMonthlyPassword.id);
                    
                    const updateData = {
                        deviceId: currentDeviceId,
                        loginTime: new Date().toISOString(),
                        online: true,
                        startTime: new Date().toISOString(),
                        used: true
                    };
                    
                    if (!validMonthlyPassword.startTime) {
                        updateData.startTime = new Date().toISOString();
                        if (validMonthlyPassword.duration) {
                            const endTime = new Date();
                            endTime.setMonth(endTime.getMonth() + validMonthlyPassword.duration);
                            updateData.endTime = endTime.toISOString();
                        }
                    }
                    
                    passwordRef.update(updateData).then(() => {
                        validMonthlyPassword.deviceId = currentDeviceId;
                        validMonthlyPassword.loginTime = new Date().toISOString();
                        validMonthlyPassword.online = true;
                        validMonthlyPassword.startTime = updateData.startTime;
                        validMonthlyPassword.endTime = updateData.endTime || validMonthlyPassword.endTime;
                        validMonthlyPassword.used = true;
                        
                        completeMonthlyUnlockProcess(password, validMonthlyPassword);
                    }).catch(error => {
                        console.error('Error updating monthly password device info:', error);
                        alert('Error unlocking videos. Please try again.');
                    });
                } else {
                    validMonthlyPassword.deviceId = currentDeviceId;
                    validMonthlyPassword.loginTime = new Date().toISOString();
                    validMonthlyPassword.online = false;
                    if (!validMonthlyPassword.startTime) {
                        validMonthlyPassword.startTime = new Date().toISOString();
                        if (validMonthlyPassword.duration) {
                            const endTime = new Date();
                            endTime.setMonth(endTime.getMonth() + validMonthlyPassword.duration);
                            validMonthlyPassword.endTime = endTime.toISOString();
                        }
                    }
                    validMonthlyPassword.used = true;
                    
                    completeMonthlyUnlockProcess(password, validMonthlyPassword);
                }
            } else {
                const timePassword = timeBasedPasswords[password];
                if (timePassword) {
                    if (timePassword.singleDevice && timePassword.deviceId && timePassword.deviceId !== currentDeviceId) {
                        loginStatus.textContent = 'This password is already registered to another device. Single device access only.';
                        loginStatus.style.color = 'var(--danger)';
                        return;
                    }
                    
                    const expirationDate = timePassword.expirationDate.toDate();
                    if (new Date() > expirationDate) {
                        loginStatus.textContent = 'This password has expired.';
                        loginStatus.style.color = 'var(--danger)';
                        return;
                    }
                    
                    if (navigator.onLine && !isOfflineMode) {
                        const passwordRef = db.collection('timePasswords').doc(password);
                        
                        passwordRef.update({
                            deviceId: currentDeviceId,
                            loginTime: new Date().toISOString()
                        }).then(() => {
                            timePassword.deviceId = currentDeviceId;
                            timePassword.loginTime = new Date().toISOString();
                            
                            completeTimeUnlockProcess(password, timePassword);
                        }).catch(error => {
                            console.error('Error updating time password device info:', error);
                            alert('Error unlocking videos. Please try again.');
                        });
                    } else {
                        timePassword.deviceId = currentDeviceId;
                        timePassword.loginTime = new Date().toISOString();
                        
                        completeTimeUnlockProcess(password, timePassword);
                    }
                } else {
                    loginStatus.textContent = 'Invalid password. Please try again.';
                    loginStatus.style.color = 'var(--danger)';
                }
            }
        }

        function completeStoryPasswordUnlockProcess(password, storyName) {
            const passwordParts = password.split('.');
            let passwordStoryName = '';
            
            if (passwordParts.length === 2) {
                passwordStoryName = passwordParts[0];
            } else if (passwordParts.length === 3) {
                passwordStoryName = passwordParts[1];
            }
            
            if (passwordStoryName.toLowerCase() !== storyName.toLowerCase()) {
                loginStatus.textContent = 'Password does not match story name. Access denied.';
                loginStatus.style.color = 'var(--danger)';
                alert('Error: Password story name does not match. Access denied.');
                return;
            }
            
            rememberPassword('global', password, { storyName: storyName });
            
            unlockVideosForStory(storyName);
            
            if (navigator.onLine && !isOfflineMode) {
                setupUserSession(password);
            }
            
            alert(`Videos from story "${storyName}" unlocked successfully!`);
        }

        function unlockVideosForStory(storyName) {
            document.querySelectorAll('.video-item').forEach(item => {
                const itemText = item.querySelector('p')?.textContent || '';
                if (itemText.includes(` ${storyName}`) || itemText.includes(storyName)) {
                    item.classList.remove('locked');
                }
            });
            
            if (!unlockedStories.includes(storyName)) {
                unlockedStories.push(storyName);
            }
            
            loginStatus.textContent = `Videos from story "${storyName}" unlocked successfully!`;
            loginStatus.style.color = 'var(--success)';
            
            renderContactLinksScreen();
        }

        function completeMonthlyUnlockProcess(password, monthlyPassword) {
            rememberPassword('monthly', password, { 
                duration: monthlyPassword.duration,
                expiry: monthlyPassword.endTime || new Date(Date.now() + monthlyPassword.duration * 30 * 24 * 60 * 60 * 1000).toISOString()
            });
            
            unlockAllContentWithMonthlyPassword(monthlyPassword);
            
            if (navigator.onLine && !isOfflineMode) {
                setupUserSession(password);
            }
            
            const durationText = monthlyPassword.duration > 1 ? 
                `${monthlyPassword.duration} months` : '1 month';
            alert(`All content unlocked successfully! Access will be valid for ${durationText}.`);
        }

        function unlockAllContentWithMonthlyPassword(monthlyPassword) {
            isUserLoggedIn = true;
            
            document.querySelectorAll('.video-item').forEach(item => {
                if (!item.classList.contains('free')) {
                    item.classList.remove('locked');
                }
            });
            
            loginStatus.textContent = `All content unlocked with ${monthlyPassword.duration}-month password!`;
            loginStatus.style.color = 'var(--success)';
            
            renderContactLinksScreen();
            
            if (monthlyPassword.endTime) {
                const endTime = new Date(monthlyPassword.endTime);
                startPasswordExpirationTimer(endTime);
                passwordTimerDisplay.style.display = 'block';
            }
        }

        function completeTimeUnlockProcess(password, timePassword) {
            rememberPassword('time', password, { 
                expiry: timePassword.expirationDate.toDate().toISOString() 
            });
            
            activeTimePassword = password;
            
            unlockAllContentWithTimePassword();
            
            startPasswordExpirationTimer(timePassword.expirationDate.toDate());
            
            alert(`All videos and contact links unlocked successfully! Access will expire on ${timePassword.expirationDate.toDate().toLocaleDateString()}.`);
        }

        function unlockAllContentWithTimePassword() {
            isUserLoggedIn = true;
            
            document.querySelectorAll('.video-item').forEach(item => {
                if (!item.classList.contains('free')) {
                    item.classList.remove('locked');
                }
            });
            
            loginStatus.textContent = `All content unlocked with time-based password!`;
            loginStatus.style.color = 'var(--success)';
            
            renderContactLinksScreen();
            
            passwordTimerDisplay.style.display = 'block';
        }

        function startPasswordExpirationTimer(expirationDate) {
            if (passwordExpirationTimer) {
                clearInterval(passwordExpirationTimer);
            }
            
            updatePasswordTimer(expirationDate);
            
            passwordExpirationTimer = setInterval(() => {
                updatePasswordTimer(expirationDate);
            }, 1000);
        }

        function updatePasswordTimer(expirationDate) {
            const now = new Date();
            const timeLeft = expirationDate - now;
            
            if (timeLeft <= 0) {
                timerText.textContent = 'Password expired!';
                lockTimeBasedContent();
                clearInterval(passwordExpirationTimer);
                return;
            }
            
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            let timerString = 'Password expires in: ';
            if (days > 0) {
                timerString += `${days}d `;
            }
            timerString += `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            timerText.textContent = timerString;
        }

        function lockTimeBasedContent() {
            activeTimePassword = null;
            
            localStorage.removeItem('timePassword');
            localStorage.removeItem('timePasswordExpiration');
            localStorage.removeItem('monthlyPassword');
            localStorage.removeItem('monthlyPasswordExpiry');
            
            passwordTimerDisplay.style.display = 'none';
            
            isUserLoggedIn = false;
            loginStatus.textContent = 'Please enter your password to unlock all videos';
            loginStatus.style.color = 'var(--accent)';
            
            renderVideoLibraryWithDownloads();
            
            renderContactLinksScreen();
            
            alert('Your access has expired or been revoked. All content is now locked.');
        }

        function checkActiveMonthlyPassword() {
            const rememberedPasswords = JSON.parse(localStorage.getItem('rememberedPasswords') || '{}');
            
            if (rememberedPasswords.monthly) {
                const monthlyData = rememberedPasswords.monthly;
                const now = new Date();
                const expiry = new Date(monthlyData.expiry);
                
                if (now < expiry) {
                    const validPassword = monthlyPasswords.find(p => p.password === monthlyData.password);
                    if (validPassword) {
                        if (validPassword.singleDevice && validPassword.deviceId && validPassword.deviceId !== currentDeviceId) {
                            delete rememberedPasswords.monthly;
                            localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
                            return;
                        }
                        
                        document.getElementById('password').value = monthlyData.password;
                        unlockVideos();
                    } else {
                        delete rememberedPasswords.monthly;
                        localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
                    }
                } else {
                    delete rememberedPasswords.monthly;
                    localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
                }
            }
        }

        function checkActiveTimePassword() {
            const rememberedPasswords = JSON.parse(localStorage.getItem('rememberedPasswords') || '{}');
            
            if (rememberedPasswords.time) {
                const timeData = rememberedPasswords.time;
                const now = new Date();
                const expiry = new Date(timeData.expiry);
                
                if (now < expiry) {
                    activeTimePassword = timeData.password;
                    unlockAllContentWithTimePassword();
                    startPasswordExpirationTimer(expiry);
                } else {
                    delete rememberedPasswords.time;
                    localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
                }
            }
        }

        function setupUserSession(password) {
            if (!navigator.onLine || isOfflineMode) return;
            
            userSessionRef = rtdb.ref('userSessions/' + password + '/' + currentDeviceId);
            
            userSessionRef.set({
                loginTime: new Date().toISOString(),
                lastActive: firebase.database.ServerValue.TIMESTAMP,
                deviceInfo: navigator.userAgent,
                online: true
            });
            
            setInterval(() => {
                if (userSessionRef && navigator.onLine && !isOfflineMode) {
                    userSessionRef.update({
                        lastActive: firebase.database.ServerValue.TIMESTAMP,
                        online: true
                    });
                }
            }, 30000);
            
            userSessionRef.onDisconnect().update({
                online: false,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function showScreen(screenNumber) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.getElementById(`screen${screenNumber}`).classList.add('active');
        }

        function renderContactLinksScreen() {
            contactLinksScreenList.innerHTML = '';
            
            contactLinksData.forEach(link => {
                const isFree = link.accessType === 'free';
                const isUnlocked = isUserLoggedIn || 
                    (!link.storyName) || 
                    (link.storyName && unlockedStories.includes(link.storyName)) ||
                    activeTimePassword;
                
                if (isFree || isUnlocked) {
                    const linkItem = document.createElement('div');
                    linkItem.className = 'video-item';
                    
                    let icon = '';
                    let btnClass = 'contact-btn ';
                    switch(link.type) {
                        case 'facebook':
                            icon = '<i class="fab fa-facebook-f"></i>';
                            btnClass += 'facebook-btn';
                            break;
                        case 'telegram':
                            icon = '<i class="fab fa-telegram"></i>';
                            btnClass += 'telegram-btn';
                            break;
                        case 'viber':
                            icon = '<i class="fab fa-viber"></i>';
                            btnClass += 'viber-btn';
                            break;
                        default:
                            icon = '<i class="fas fa-link"></i>';
                            btnClass += 'other-btn';
                    }
                    
                    linkItem.innerHTML = `
                        <div style="flex: 1;">
                            <h4 style="font-size: 9px;">${link.name}</h4>
                            <p style="font-size: 8px;">${link.type.charAt(0).toUpperCase() + link.type.slice(1)} ${link.storyName ? ` ${link.storyName}` : ''}</p>
                        </div>
                        <a href="${link.url}" target="_blank" class="${btnClass}">${icon} Open</a>
                    `;
                    
                    contactLinksScreenList.appendChild(linkItem);
                }
            });
        }

        function toggleStoryMenu() {
            storyMenu.classList.toggle('active');
        }

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.story-collection-menu') && storyMenu.classList.contains('active')) {
                storyMenu.classList.remove('active');
            }
        });

        function updateConnectionStatus() {
            if (navigator.onLine) {
                connectionStatus.className = 'connection-status online-status-badge';
                connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> Online';
                connectionStatus.style.display = 'flex';
                isOfflineMode = false;
                
                const offlineIndicator = document.querySelector('.offline-indicator');
                if (offlineIndicator) {
                    offlineIndicator.remove();
                }
            } else {
                connectionStatus.className = 'connection-status offline-status-badge';
                connectionStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline';
                connectionStatus.style.display = 'flex';
                isOfflineMode = true;
                
                if (!document.querySelector('.offline-indicator')) {
                    const offlineIndicator = document.createElement('div');
                    offlineIndicator.className = 'offline-indicator';
                    offlineIndicator.innerHTML = '<i class="fas fa-wifi-slash"></i> You are currently offline';
                    document.body.appendChild(offlineIndicator);
                }
                
                const hasDownloadedVideos = checkOfflineVideos();
                if (!hasDownloadedVideos) {
                    setTimeout(() => {
                        noInternetModal.style.display = 'flex';
                    }, 1000);
                }
            }
            
            renderVideoLibraryWithDownloads();
        }

        function checkOfflineVideos() {
            const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
            
            const now = new Date();
            let hasExpired = false;
            
            Object.keys(downloadedVideos).forEach(videoId => {
                if (downloadedVideos[videoId].expires && new Date(downloadedVideos[videoId].expires) < now) {
                    if (downloadedVideos[videoId].storagePath) {
                        deleteFromSecureStorage(downloadedVideos[videoId].storagePath);
                    }
                    delete downloadedVideos[videoId];
                    hasExpired = true;
                }
            });
            
            if (hasExpired) {
                localStorage.setItem('downloadedVideos', JSON.stringify(downloadedVideos));
            }
            
            if (Object.keys(downloadedVideos).length > 0) {
                downloadedVideosSection.style.display = 'block';
                renderDownloadedVideosSection();
            }
            
            return Object.keys(downloadedVideos).length > 0;
        }

        function setStyleMode(mode) {
            document.body.classList.remove('normal-mode', 'digital-mode', 'dark-mode');
            document.body.classList.add(`${mode}-mode`);
            
            normalModeBtn.classList.remove('active');
            digitalModeBtn.classList.remove('active');
            darkModeBtn.classList.remove('active');
            
            if (mode === 'normal') {
                normalModeBtn.classList.add('active');
                document.querySelector('.digital-bg').style.display = 'none';
                document.querySelector('.digital-grid').style.display = 'none';
                document.querySelector('.digital-particles').style.display = 'none';
            } else if (mode === 'digital') {
                digitalModeBtn.classList.add('active');
                document.querySelector('.digital-bg').style.display = 'block';
                document.querySelector('.digital-grid').style.display = 'block';
                document.querySelector('.digital-particles').style.display = 'block';
                createEnhancedParticles();
            } else if (mode === 'dark') {
                darkModeBtn.classList.add('active');
                document.querySelector('.digital-bg').style.display = 'none';
                document.querySelector('.digital-grid').style.display = 'none';
                document.querySelector('.digital-particles').style.display = 'none';
            }
            
            localStorage.setItem('preferredStyleMode', mode);
        }

        function initStyleSelector() {
            setStyleMode('digital');
            
            normalModeBtn.addEventListener('click', () => setStyleMode('normal'));
            digitalModeBtn.addEventListener('click', () => setStyleMode('digital'));
            darkModeBtn.addEventListener('click', () => setStyleMode('dark'));
        }

        unlockVideosBtn.addEventListener('click', unlockVideos);
        unlockStoryBtn.addEventListener('click', unlockStory);
        showContactLinksScreen.addEventListener('click', () => showScreen(4));
        backToScreen1FromContacts.addEventListener('click', () => showScreen(1));
        storyMenuToggle.addEventListener('click', toggleStoryMenu);

        continueOfflineBtn.addEventListener('click', function() {
            noInternetModal.style.display = 'none';
            
            const hasDownloadedVideos = checkOfflineVideos();
            if (hasDownloadedVideos) {
                renderDownloadedVideosSection();
                alert('You can access your downloaded videos in the "Downloaded Videos" section.');
            } else {
                alert('No downloaded videos available. Please connect to the internet to download videos.');
            }
        });

        closeNoInternetModal.addEventListener('click', () => {
            noInternetModal.style.display = 'none';
        });

        document.addEventListener('contextmenu', function(e) {
            if (e.target.tagName === 'VIDEO' || e.target.tagName === 'IFRAME' || e.target.tagName === 'IMG') {
                e.preventDefault();
                return false;
            }
        });

        document.addEventListener('keydown', function(e) {
            if (
                e.keyCode === 123 ||
                (e.ctrlKey && e.shiftKey && e.keyCode === 73) ||
                (e.ctrlKey && e.shiftKey && e.keyCode === 74) ||
                (e.ctrlKey && e.shiftKey && e.keyCode === 67) ||
                (e.ctrlKey && e.keyCode === 85)
            ) {
                e.preventDefault();
                return false;
            }
        });

        initApp();
        initStyleSelector();
    </script>
</body>
</html>